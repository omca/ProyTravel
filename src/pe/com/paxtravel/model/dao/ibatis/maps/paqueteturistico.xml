<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="paqueteturistico">
	
	<typeAlias alias="paqueteTuristicoBean" type="pe.com.paxtravel.bean.PaqueteTuristicoBean" />
	<typeAlias alias="tourBean" type="pe.com.paxtravel.bean.TourBean" />
	
	<typeAlias alias="string" type="java.lang.String" />
	
	<resultMap id="listadoPaqueteTuristico" class="paqueteTuristicoBean">	
		<result property="numeroFila"			    column="ca_nume_fila" />		
		<result property="idPaquete"			    column="id_paquete" />
		<result property="nombre" 		    		column="nombre" />
		<result property="idEstado" 				column="id_estado" />
		<result property="observacion" 		    	column="observacion" />
		<result property="idOrden"			    	column="id_orden" />
		<result property="fecha" 		    		column="fecha" />
		<result property="feInicio" 		    	column="fe_partida" />
		<result property="feFin" 		    		column="fe_retorno" />
		<result property="idTrabajador"			    column="id_usuario_ins" />
		<result property="noEstado"				    column="no_estado"/>
		<result property="noCliente"				column="cliente"/>	
		<result property="fechRango"				column="fech_rango"/>			
	</resultMap>

	<resultMap id="resultPaqueteTuristico" class="paqueteTuristicoBean">			
		<result property="idPaquete"			    column="id_paquete" />
		<result property="nombre" 		    		column="nombre" />
		<result property="idEstado" 				column="id_estado" />
		<result property="observacion" 		    	column="observacion" />
		<result property="idOrden"			    	column="id_orden" />
		<result property="fecha" 		    		column="fecha" />
		<result property="feInicio" 		    	column="fe_partida" />
		<result property="feFin" 		    		column="fe_retorno" />
		<result property="idTrabajador"			    column="id_usuario_ins" />
		<result property="nuNinos"					column="nu_ninos"/>
		<result property="nuAdultos"				column="nu_adultos"/>
		<result property="noEstado"				    column="no_estado"/>
		<result property="noCliente"				column="cliente"/>	
		<result property="fechRango"				column="fech_rango"/>	
	</resultMap>
	
	<resultMap id="resultTour"             class="tourBean">			
		<result property="idTour"			    column="id_tour" />
		<result property="idDestinoCiudad" 		column="id_destino_ciudad" />
		<result property="duracion" 			column="duracion" />
		<result property="precioAdulto" 		column="precio_adulto" />
		<result property="precioNino"			column="precio_niño" />
		<result property="descripcion" 		    column="descripcion" />
		<result property="itinerario" 		    column="itinerario" />
		<result property="servicios" 		    column="servicios" />
	</resultMap>		
	
	<select id="obtenerCodigoPaqTuristico" resultClass="java.lang.String">
		SELECT CONCAT('ORDE',
               YEAR(NOW()), 
               IF( LENGTH(MONTH(NOW()))=1,CONCAT('0',MONTH(NOW())),MONTH(NOW()) ),
               MAX( SUBSTR( numeroFila, 11) ) +1 
               ) AS nu_Fila
         FROM paquete_turistico;
	</select>
	
	<select id="listarTour" parameterClass="tourBean" resultMap="resultTour">
			select id_tour,
			       id_destino_ciudad,
			       duracion,
			       precio_adulto,
			       precio_niño,
			       descripcion,
			       itinerario,
			       servicios
			 from tour
			 where id_destino_ciudad = #idDestinoCiudad#      
	</select>	
	
	<select id="listarPaqueteTuristico" parameterClass="paqueteTuristicoBean" resultMap="listadoPaqueteTuristico">		
		SELECT 		
			   @rownum:=@rownum+1 AS ca_nume_fila,
			   paquete.id_paquete ,  
			   paquete.nombre , 
			   paquete.id_estado , 
			   paquete.observacion ,  
			   paquete.id_orden , 
			   DATE_FORMAT(paquete.fecha,'%d-%m-%Y') fecha,
			   DATE_FORMAT(paquete.fe_partida,'%d-%m-%Y') fe_partida,
			   DATE_FORMAT(paquete.fe_retorno,'%d-%m-%Y') fe_retorno,
			   paquete.id_usuario_ins,
			   paquete.nu_ninos,
			   paquete.nu_adultos,
			   est.no_estado,
			   CONCAT(clie.nombres,' ',clie.apellidos) cliente,	
			   CONCAT(convert(DATE_FORMAT(paquete.fe_partida,'%d-%m-%Y'),char),"/",convert(DATE_FORMAT(paquete.fe_retorno,'%d-%m-%Y'),char)) fech_rango
         FROM (SELECT @rownum:=0) r, paquete_turistico paquete  
         inner JOIN orden orden ON orden.id_orden=paquete.id_orden
         inner JOIN cliente clie ON orden.id_cliente=clie.id_cliente
         inner join estado est on paquete.id_estado = est.id_estado                
		 WHERE 1 = 1
		 <isGreaterThan compareValue="0" prepend="AND" property="idOrden"> paquete.id_orden = #idOrden# </isGreaterThan>
	     <isGreaterThan compareValue="0" prepend="AND" property="idEstado"> paquete.id_estado = #idEstado# </isGreaterThan>
		 <isNotEmpty prepend="AND" property="noCliente"> CONCAT(clie.nombres,' ',clie.apellidos) LIKE #noCliente# </isNotEmpty>
		 <isNotEmpty prepend="AND" property="numDocCliente"> clie.nu_documento = #numDocCliente# </isNotEmpty>
		 <isNotEmpty prepend="AND" property="feInicio" >
	         <isNotEmpty property="feFin" >
	            DATE_FORMAT(paquete.fecha,'%Y-%m-%d') between #feInicio# AND #feFin#
	         </isNotEmpty>
   		 </isNotEmpty>
		 
		
	</select>
  
	<insert id="insertarPaqueteTuristico" parameterClass="paqueteTuristicoBean">
		INSERT INTO paquete_turistico(
			nombre,
			id_estado,
			observacion,
			id_orden,
			fecha,
			fe_partida,
			fe_retorno,
			id_usuario_ins,
			nu_ninos,
			nu_adultos
		) 
		VALUES 
		(
			#nombre#,
			#idEstado#,
			#observacion#,
			#idOrden#,
			#fecha#,
			#feInicio#,
			#feFin#,
			#idTrabajador#,
			#nuNinos#,
			#nuAdultos#		
		)		
	</insert>

	<select id="obtenerNumeroPaqTuristico" resultClass="string">
		SELECT CONCAT('COTI',
               YEAR(NOW()), 
               IF( LENGTH(MONTH(NOW()))=1,CONCAT('0',MONTH(NOW())),MONTH(NOW()) ),
               MAX( SUBSTR( NU_COTIZA, 11) ) +1 
               ) AS NRO_COTIZA
        FROM COTIZACION;
	</select>
	
</sqlMap>