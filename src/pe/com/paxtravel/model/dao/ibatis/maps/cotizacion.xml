<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="cotizacion">

	<typeAlias alias="cotizacionDetalleTicketVueloBean" type="pe.com.paxtravel.bean.CotizacionDetalleTicketVueloBean" />
	<typeAlias alias="fareInfoBean" type="pe.com.paxtravel.bean.FareInfoBean" />	
	<typeAlias alias="cotizacionBean" type="pe.com.paxtravel.bean.CotizacionBean" />
	<typeAlias alias="cotizacionDetalleBean" type="pe.com.paxtravel.bean.CotizacionDetalleBean" />
	<typeAlias alias="ciudadBean" type="pe.com.paxtravel.bean.CiudadBean" />
	<typeAlias alias="paisBean" type="pe.com.paxtravel.bean.PaisBean" />
	<typeAlias alias="motivoViajeBean" type="pe.com.paxtravel.bean.MotivoViajeBean" />
	<typeAlias alias="servicioAdicionalBean" type="pe.com.paxtravel.bean.ServicioAdicionalBean" />
	<typeAlias alias="hotelHabitacionBean" type="pe.com.paxtravel.bean.HotelHabitacionBean" />
	<typeAlias alias="clienteBean" type="pe.com.paxtravel.bean.ClienteBean" />
	<typeAlias alias="cotizacionServicioBean" type="pe.com.paxtravel.bean.CotizacionServicioBean" />
	
	<!-- Bean Busqueda de Paquetes - Inicio -->
	
	<typeAlias alias="paqueteManagerBean" type="pe.com.paxtravel.tree.data.PaqueteManagerBean" />
	
	<!-- Bean Busqueda de Paquetes - Fin -->
	
	<typeAlias alias="string" type="java.lang.String" />
	
	<resultMap id="resultFareInfo" class="fareInfoBean">
						
		<result property="comision"		    column="comision" />
		<result property="nombreProveedor" 		    column="proveedor" />
		<result property="nombreAerolinea" 		    column="aerolinea" />	
		<result property="idProveedor" 		    column="id_proveedor" />
		<result property="idAerolinea" 		    column="id_aerolinea" />		
		
	</resultMap>

	<resultMap id="resultCotizacion" class="cotizacionBean">
		<result property="numeroFila"			    column="ca_nume_fila" />
		<result property="idCotizacion"			    column="id_cotiza" />
		<result property="numeroCotizacion"		    column="nu_cotiza" />
		<result property="fechaCotizacion" 		    column="fe_cotiza" />
		<result property="nombreCliente" 		    column="cliente" />
		<result property="nombreEstadoCotizacion" 	column="no_estado" />
		<result property="descripcion" 		        column="descripcion" />
		
<!-- 		<result property="tiempoMinimo" 	     	column="tiempo_min" /> -->
<!-- 		<result property="tiempoMaximo" 	    	column="tiempo_max" /> -->
<!-- 		<result property="seguroViaje" 				column="seguro_viaje" /> -->
		<result property="fechaSalida" 	        	column="fe_partida" />
		<result property="fechaRetorno" 			column="fe_retorno" />
		
		<result property="idOrigen" 			column="origen_partida" />
		<result property="idDestino" 			column="id_destino" />
		
<!-- 		<result property="boletoAvion" 				column="boleto_avion" /> -->
		<result property="observacion" 				column="observacion" />
		<result property="tipoAlojamiento" 				column="id_tipo_alojamiento" />
		<result property="categoriaAlojamiento" 				column="id_categoria_alojamiento" />
		<result property="cantidadAdultos" 				column="nu_adultos" />
		<result property="cantidadNinos" 				column="nu_ninos" />
		<result property="presupuestoMinimo" 				column="im_presupuesto_minimo" />
		<result property="presupuestoMaximo" 				column="im_presupuesto_maximo" />
		
		<result property="observacion" 				column="observacion" />
		
	</resultMap>
	
	<resultMap id="resultPais" class="paisBean">
		<result property="idPais"			    column="id_destino" />
		<result property="nomPais"			    column="descripcion" />
	</resultMap>
	
	<resultMap id="resultCotizacionServicio" class="cotizacionServicioBean">
		<result property="idCotiza"			    column="id_cotiza" />
		<result property="idServicio"			    column="id_servicio" />
	</resultMap>
	
	<resultMap id="resultCiudad" class="ciudadBean">
		<result property="idCiudad"			    column="id_destino_ciudad" />
		<result property="idPais"			    column="id_destino_pais" />
		<result property="nomCiudad"			    column="descripcion" />
	</resultMap>
	
	
	<resultMap id="resultCliente" class="clienteBean">
		<result property="idCliente"			    column="id_cliente" />
		<result property="nombre"	        column="nombre_cliente" />
		<result property="age"	        column="age" />		
	</resultMap>
	
	
	
	<resultMap id="resultPaquetes" class="paqueteManagerBean">
		<result property="idPaquete"			    column="id_paquete" />
		<result property="nomPaquete"			    column="nombre" />
		<result property="comentario"			    column="observacion" />
		<result property="imPrecio"			    column="im_precio" />
		<result property="tiPresupuestoValue"	column="ti_presupuesto" />
	</resultMap>
	
	<resultMap id="resultPaqueteDestinos" class="paqueteManagerBean">
		<result property="idPaqueteDestino"			    column="id" />
		<result property="idPaquete"			    column="id_destino_ciudad" />		
		<result property="nomPaquete"			    column="nom_ciudad" />
		<result property="nuDias"			    column="nu_dias" />
	</resultMap>		
	
	<resultMap id="resultPaqueteDestinoTour" class="paqueteManagerBean">
		<result property="idPaqueteDestinoTour"			    column="id_paquete_destino_tour" />
		<result property="idPaqueteDestino"			    column="id_paquete_destino" />
		<result property="idTour"			    column="id_tour" />
		<result property="desTour"			    column="descripcion" />
		<result property="imPrecioAdulto"			    column="im_precio_adulto" />
		<result property="imPrecioNino"			    column="im_precio_nino" />
	</resultMap>		
	
	<resultMap id="resultPaqueteDestinoHotel" class="paqueteManagerBean">
		<result property="idPaqueteDestinoHotel"    column="id_paquete_destino_hotel" />
		<result property="idPaqueteDestino"			    column="id_paquete_destino" />
		<result property="idHotel"			    column="id_hotel" />
		<result property="idProveedor"			    column="id_proveedor" />
		<result property="idTipoAlojamiento"			    column="id_tipo_alojamiento" />
		<result property="idCategoriaAlojamiento"			    column="id_categoria_alojamiento" />
		<result property="idHotelHabitacion"			    column="id_hotel_habitacion" />
		<result property="nomTipoAlojamiento"			    column="tipo_alojamiento" />
		<result property="nomProveedor"			    column="proveedor" />
		<result property="nomHotel"			    column="hotel" />
		<result property="nomCategoriaAlojamiento"    column="categoria_alojamiento" />
		<result property="desAlojamiento"			    column="descripcion_alojamiento" />
		<result property="imPrecio"			    column="im_precio" />		
	</resultMap>
	
	<resultMap id="resultPaqueteDestinoTicket" class="paqueteManagerBean">
		 	<result property="idPaqueteTicket"			    column="id_paquete_ticket" />
		 	<result property="idPaquete"			    column="id_paquete_turistico" />
		 	<result property="nomAerolinea"			    column="nom_aerolinea" />
		 	<result property="codeAerolinea"			    column="code_aerolinea" />
		 	<result property="imPrecio"			    column="im_precio" />		 
	</resultMap>
	
	<resultMap id="resultCotizacionResume" class="cotizacionBean">
		<result property="idCotizacion" column="id_cotiza" />
		<result property="numeroCotizacion" column="nu_cotiza" />
		<result property="nombreCliente" column="cliente" />
		<result property="fechaCotizacion" column="fe_cotiza" />		
		<result property="tipoCotizacion" column="cotizacion" />
		<result property="tipoPrograma" column="programa" />
		<result property="estado" column="estado" />
		<result property="tipoAlojamiento" column="alojamiento" />
		<result property="categoriaAlojamiento" column="categoriaAlojamiento" />
		<result property="destinos" column="destinos" />
		<result property="habitaciones" column="habitaciones" />
		<result property="motivos" column="motivos" />
		<result property="servicios" column="servicios" />
		<result property="idTipoCotizacion" column="id_tipo_cotizacion" />
		<result property="idEstado" column="id_estado" />
	</resultMap>
	
	<select id="listarCotizacion" parameterClass="cotizacionBean" resultMap="resultCotizacion">
		SELECT  @rownum:=@rownum+1 AS ca_nume_fila, coti.id_cotiza, coti.nu_cotiza,
                DATE_FORMAT(coti.fe_cotiza,'%d-%m-%Y') fe_cotiza,
                CONCAT(clie.nombres,' ',clie.apellidos) cliente, e.no_estado as no_estado,
                coti.descripcion,               
				IF(coti.fe_partida='00-00-0000', NULL, coti.fe_partida) as fe_partida,                 
                IF(coti.fe_retorno='00-00-0000', NULL, coti.fe_retorno) as fe_retorno, 
                coti.observacion,
                coti.origen_partida,				 
				coti.id_cliente, 
				coti.id_estado, 
				coti.id_destino, 
				coti.id_tipo_programa, 
				coti.id_tipo_cotiza, 
				coti.nu_adultos, 
				coti.nu_ninos, 
				coti.id_tipo_alojamiento, 
				coti.id_categoria_alojamiento, 
				coti.im_presupuesto_minimo, 
				coti.im_presupuesto_maximo
          FROM (SELECT @rownum:=0) r, cotizacion coti 
       INNER JOIN cliente clie ON coti.id_cliente=clie.id_cliente   
       INNER JOIN estado as e ON (coti.id_estado=e.id_estado)    
		  WHERE 1 = 1
	      <isNotEmpty prepend="AND" property="fechaCotizacion"> DATE_FORMAT(coti.fe_cotiza,'%Y-%m-%d')  = #fechaCotizacion# </isNotEmpty>
	      <isNotEmpty prepend="AND" property="numeroCotizacion"> coti.nu_cotiza = #numeroCotizacion# </isNotEmpty> 
	      <isNotEmpty prepend="AND" property="codigoEstadoCotizacion"> coti.id_estado = #codigoEstadoCotizacion# </isNotEmpty> 
	      <isNotEmpty prepend="AND" property="nombreCliente"> CONCAT(clie.nombres,' ',clie.apellidos) LIKE #nombreCliente# </isNotEmpty>
	      <isNotEmpty prepend="AND" property="documentoCliente"> clie.nu_documento = #documentoCliente# </isNotEmpty>
	</select>
	
	<select id="obtenerNumeroCotizacion" resultClass="string">
		SELECT CONCAT('COTI',
               YEAR(NOW()), 
               IF( LENGTH(MONTH(NOW()))=1,CONCAT('0',MONTH(NOW())),MONTH(NOW()) ),
               MAX( SUBSTR( NU_COTIZA, 11) ) +1 
               ) AS NRO_COTIZA
         FROM COTIZACION;
	</select>
	
	<select id="listarCiudad" parameterClass="ciudadBean" resultMap="resultCiudad">
		SELECT id_destino_ciudad, id_destino_pais, descripcion FROM destino_ciudad 
         WHERE 1=1
		<isNotEmpty prepend="AND" property="idPais"> id_destino_pais = #idPais# </isNotEmpty>
	</select>
	
	<select id="listarCotizacionServicio" parameterClass="cotizacionServicioBean" resultMap="resultCotizacionServicio">
		select id_cotiza,
			   id_servicio
		from cotizacion_servicio
		where id_cotiza = #idCotiza#
		and	  id_servicio = #idServicio# 			
	</select>	
	
	<select id="listarPais" parameterClass="paisBean" resultMap="resultPais">
		SELECT id_destino, descripcion FROM destino_pais 
		WHERE 1=1
		<isNotEmpty prepend="AND" property="idPais"> id_destino != #idPais# </isNotEmpty>
	</select>	
	
	<insert id="insertarCotizacion" parameterClass="cotizacionBean" >
		INSERT INTO cotizacion(
			nu_cotiza,
			fe_cotiza,			
			fe_partida,
			fe_retorno,
			origen_partida,
			id_tipo_cotiza,
			id_tipo_programa,
			id_tipo_alojamiento,
			id_categoria_alojamiento,
			nu_adultos,
			nu_ninos,
			im_presupuesto_minimo,
			im_presupuesto_maximo,
			observacion,
			id_cliente,
			fe_ins
		) VALUES (
			#numeroCotizacion#,
			#fechaCotizacion#,						
			#fechaSalida#,
			#fechaRetorno#,
			#idOrigenPartida#,
			#idTipoCotizacion#,
			#idTipoPrograma#,
			#tipoAlojamiento#,
			#categoriaAlojamiento#,
			#cantidadAdultos#,
			#cantidadNinos#,
			#presupuestoMinimo#,
			#presupuestoMaximo#,
			#observacion#,
			#idCliente#,
			sysdate()
		)
		<selectKey keyProperty="idCotizacion" resultClass="int">
            select LAST_INSERT_ID();
        </selectKey>
	</insert>
	
	<insert id="insertarMotivoViaje" parameterClass="motivoViajeBean">
		INSERT INTO cotizacion_motivo(
			id_cotiza,
			id_motivo
		) VALUES (
			#numeroCotizacion#,
			#codigoMotivo#
		)
	</insert>
	
	<insert id="insertarServicioAdicional" parameterClass="servicioAdicionalBean">
		INSERT INTO cotizacion_servicio(
			id_cotiza,
			id_servicio
		) VALUES (
			#numeroCotizacion#,
			#codigoServicio#
		)
	</insert>
	
	<insert id="insertarCotizacionDetalle" parameterClass="cotizacionDetalleBean">
		INSERT INTO cotizacion_deta(
			id_cotiza,
			id_destino_origen,
			id_destino
		) VALUES (
			#numeroCotizacion#,
			#origen#,
			#destino#
		)
	</insert>
	
	<insert id="insertarCotizacionTicket" parameterClass="cotizacionBean">
		INSERT INTO cotizacion(
			nu_cotiza,
			fe_cotiza,
			descripcion,
			fe_partida,
			fe_retorno,
			nu_adultos,
			nu_ninos,
			id_cliente
		) VALUES (
			#numeroCotizacion#,
			#fechaCotizacion#,
			#descripcion#,
			#fechaSalida#,
			#fechaRetorno#,
			#cantidadAdultos#,
			#cantidadNinos#,
			#idCliente#
		)
	</insert>
	
	<insert id="insertarCotizacionDetalleTicket" parameterClass="cotizacionDetalleBean">
		INSERT INTO cotizacion_deta(
			id_cotiza,
			id_destino_origen,
			id_destino,
			ti_ida,
			fe_partida,
			fe_retorno			
		) VALUES (
			#numeroCotizacion#,
			#origen#,
			#destino#,
			#tiIda#,
			#fechaPartida#,
			#fechaRetorno#			
		)
	</insert>
		
	<select id="obtenerNombreCliente" parameterClass="clienteBean" resultMap="resultCliente">
		SELECT id_cliente, CONCAT(nombres, ' ', apellidos) AS nombre_cliente, TIMESTAMPDIFF(YEAR,fecha_nac,NOW()) AS age  
		  FROM cliente
         WHERE tipo_docu = #tipoDocumento# AND nu_documento = #numeroDocumento#
	</select>

	<insert id="insertarCotizacionDetalleTicketVueloTab2" parameterClass="cotizacionDetalleTicketVueloBean">
		INSERT INTO cotizacion_deta_ticket(
				id_cotiza_deta,
				id_cotiza,
				id_aerolinea,
				im_precio,
				id_proveedor,
				url_shop
		) VALUES (
				#idCotizaDeta#,
				#idCotiza#,
				#idAerolinea#,
				#imPrecio#,
				#idProveedor#,
				#urlShop#
		)
	</insert>
	
	<select id="getConsolidador" parameterClass="fareInfoBean" resultMap="resultFareInfo">	
	
		SELECT  				
				pad.comision,
			    p.nombre as proveedor,
			    a.nombre as aerolinea,
			    p.id_proveedor,
			    a.id_aerolinea
                
       FROM 
	       		aerolinea a
				inner join proveedor_aerolinea_destino pad on (a.id_aerolinea = pad.id_aerolinea )
				inner join destino_ciudad d on (d.id_destino_ciudad = pad.id_destino_ciudad)
				inner join proveedor p on (p.id_proveedor = pad.id_proveedor) 
         
	   WHERE 

				a.code_aerolinea  = #airlineCode# AND 
	   			d.descripcion = #destino#
	      
	  ORDER BY pad.comision DESC   
	    	      
	  LIMIT 1
	      
	</select>
	
	<insert id="insertarHabitacionHotel" parameterClass="hotelHabitacionBean">
		INSERT INTO cotizacion_deta_habitacion(
			id_cotiza,
			id_tipo_habitacion,
			nu_habitacion
		) VALUES (
			#idCotiza#,
			#idTipoHabitacion#,
			#nuHabitacion#
		)
	</insert>
	
		
	
	<select id="listarPaqueteDestinos" parameterClass="paqueteManagerBean" resultMap="resultPaqueteDestinos">
		SELECT ptD.id_destino_ciudad as id_destino_ciudad, cD.descripcion AS nom_ciudad, ptD.nu_dias ,
			ptD.id_paquete_destino as id
		FROM paquete_turistico_destino AS ptD 
        	INNER JOIN destino_ciudad AS cD ON (cD.id_destino_ciudad = ptD.id_destino_ciudad)
    	WHERE ptD.id_paquete_turistico = #idPaquete# AND id_destino_ciudad IN 
    		<iterate open="(" close=")" conjunction=",">
			   #list.destino#
			</iterate>
    	 ;
	</select>
	
	<select id="listarPaquetes" parameterClass="paqueteManagerBean" resultMap="resultPaquetes">
		SELECT id_paquete, nombre, observacion, im_precio, #tiPresupuestoValue# AS ti_presupuesto 
			FROM paquete_turistico  
		WHERE id_estado = 1 and id_tipo_paquete = 1 AND <![CDATA[im_precio<=#imPrecioMax# and im_precio>=#imPrecioMin#]]> 		
	</select>
	
	<select id="listarPaqueteDestinoTours" parameterClass="paqueteManagerBean" resultMap="resultPaqueteDestinoTour">
		SELECT id_paquete_destino_tour, id_paquete_destino, id_tour, descripcion, im_precio_adulto, im_precio_nino 
		FROM proytraveldb.paquete_turistico_destino_tour
	</select>
	
	<select id="listarPaqueteDestinoHoteles" parameterClass="paqueteManagerBean" resultMap="resultPaqueteDestinoHotel">
		SELECT 
			pTDH.id_paquete_destino_hotel, 
		    pTDH.id_paquete_destino, 
		    pTDH.id_hotel, 
		    pTDH.id_proveedor, 
		    pTDH.id_tipo_alojamiento, 
		    pTDH.id_categoria_alojamiento, 
		    pTDH.id_hotel_habitacion, 
		    tA.descripcion AS tipo_alojamiento,
		    P.nombre AS proveedor,
		    H.descripcion AS hotel,
		    tCA.nombre AS categoria_alojamiento,    	
		    pTDH.descripcion_alojamiento, 
		    pTDH.im_precio     
		FROM proytraveldb.paquete_turistico_destino_hotel AS pTDH 
			INNER JOIN proveedor AS P ON (pTDH.id_proveedor = P.id_proveedor)
		    INNER JOIN hotel as H ON (pTDH.id_hotel = H.id_hotel)
		    INNER JOIN tipo_alojamiento as tA ON (tA.id_tipo_alojamiento=pTDH.id_tipo_alojamiento)
		    INNER JOIN tipo_categoria_alojamiento AS tCA ON (pTDH.id_categoria_alojamiento=tCA.id_tipo)
		    INNER JOIN hotel_habitacion AS hH ON (pTDH.id_hotel_habitacion=hH.id_hotel_habitacion) 
	</select>
	
	<select id="listarPaqueteDestinoTickets" parameterClass="paqueteManagerBean" resultMap="resultPaqueteDestinoTicket">
		SELECT 
			pTT.id_paquete_ticket,
			pTT.id_paquete_turistico,
			A.nombre AS nom_aerolinea, 
			A.code_aerolinea,
		    pTT.im_precio
		 FROM proytraveldb.paquete_turistico_ticket AS pTT		
		INNER JOIN aerolinea AS A ON (pTT.id_aerolinea = A.id_aerolinea)
		INNER JOIN proveedor AS P ON (pTT.id_proveedor = P.id_proveedor)		
	</select>	
		
	<select id="rowCotizacionResume" parameterClass="cotizacionBean" resultMap="resultCotizacionResume">	
	SELECT c.nu_cotiza, c.id_cotiza, c.fe_cotiza, concat(cli.nombres, ' ',cli.apellidos) AS cliente, tc.nombre AS cotizacion,
		tc.id_tipo AS id_tipo_cotizacion, 
		tp.nombre AS programa,
		e.no_estado as estado, e.id_estado, ta.descripcion AS alojamiento, tca.nombre AS categoriaAlojamiento, 		
        GROUP_CONCAT(DISTINCT d.descripcion
					ORDER BY d.descripcion ASC
					SEPARATOR '-') AS destinos,
		GROUP_CONCAT(DISTINCT th.descripcion
					ORDER BY th.descripcion ASC
					SEPARATOR '-') AS habitaciones,
		GROUP_CONCAT(DISTINCT tm.descripcion
					ORDER BY tm.descripcion ASC
					SEPARATOR '-') AS motivos,
		GROUP_CONCAT(DISTINCT s.nombre
					ORDER BY s.nombre ASC
					SEPARATOR '-') AS servicios		
	FROM `cotizacion` as c 
		INNER JOIN `cliente` AS cli ON (c.id_cliente = cli.id_cliente)
	    INNER JOIN `tipo_cotizacion` AS tc ON (c.id_tipo_cotiza=tc.id_tipo)    
	    INNER JOIN `estado` AS e ON (e.id_estado=c.id_estado)
	    LEFT JOIN `tipo_alojamiento` AS ta ON (c.id_tipo_alojamiento=ta.id_tipo_alojamiento)
	    LEFT JOIN `tipo_categoria_alojamiento` AS tca ON (c.id_categoria_alojamiento=tca.id_tipo)    
	    LEFT JOIN `tipo_programa` AS tp ON (c.id_tipo_programa=tp.id_programa)    
		LEFT JOIN `cotizacion_deta` AS cd ON (c.nu_cotiza=cd.id_cotiza)
	    LEFT JOIN `cotizacion_deta_habitacion` AS cdh ON (c.nu_cotiza=cdh.id_cotiza)
	    LEFT JOIN `cotizacion_motivo` AS cm ON (c.nu_cotiza=cm.id_cotiza)
	    LEFT JOIN `cotizacion_servicio` AS cs ON (c.nu_cotiza=cs.id_cotiza)
	    LEFT JOIN `tipo_habitacion` AS th ON (cdh.id_tipo_habitacion=th.id_tipo_habitacion)
	    LEFT JOIN `servicios` AS s ON (cs.id_servicio=s.id_servicio)
	    LEFT JOIN `destino_ciudad` AS d ON (cd.id_destino=d.id_destino_ciudad)
	    LEFT JOIN `motivo_viaje` AS tm ON (cm.id_motivo=tm.id_motivo) 
	WHERE
		c.id_cotiza = #idCotizacion#
	GROUP BY c.nu_cotiza
	</select>

</sqlMap>