<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ordenplanificacion">

	<typeAlias alias="ordenPlanificacionBean" type="pe.com.paxtravel.bean.OrdenPlanificacionBean" />
	<typeAlias alias="string" type="java.lang.String" />
	<typeAlias alias="ordenDestinoBean" type="pe.com.paxtravel.bean.OrdenDestinoBean" />
	<typeAlias alias="ciudadBean" type="pe.com.paxtravel.bean.CiudadBean" />
	<typeAlias alias="paisBean" type="pe.com.paxtravel.bean.PaisBean" />
	<typeAlias alias="motivoViajeBean" type="pe.com.paxtravel.bean.MotivoViajeBean" />
	<typeAlias alias="servicioAdicionalBean" type="pe.com.paxtravel.bean.ServicioAdicionalBean" />
	
	

	<resultMap id="resultOrdenPlanificacion" class="ordenPlanificacionBean">

		<result property="idOrden" column="id_orden" />
		<result property="idCotiza" column="id_cotiza" />
		<result property="nuOrden" column="nu_orden" />
		<result property="observacion" column="observacion" />
		<result property="idTrabajador" column="id_usuario_ins" />
		<result property="descripcion" column="descripcion" />
		<result property="feOrder" column="fe_order" />
		<result property="autorizacion" column="autorizacion" />
		<result property="imPresupuestoMinimo" column="im_presupuesto_minimo" />
		<result property="imPresupuestoMaximo" column="im_presupuesto_maximo" />
		<result property="idCliente" column="id_cliente" />
		<result property="idEstado" column="id_estado" />
		<result property="idMoneda" column="id_moneda" />
		<result property="feInicio" column="fe_inicio" />
		<result property="feFin" column="fe_fin" />
	</resultMap>
	<resultMap id="resultPais" class="paisBean">
		<result property="idPais"			    column="id_destino" />
		<result property="nomPais"			    column="descripcion" />
	</resultMap>
	
	<resultMap id="resultCiudad" class="ciudadBean">
		<result property="idCiudad"			    column="id_destino_ciudad" />
		<result property="idPais"			    column="id_destino_pais" />
		<result property="nomCiudad"			    column="descripcion" />
	</resultMap>

	<insert id="insertarOrdenDestino" parameterClass="ordenDestinoBean">
		INSERT INTO orden_destino(
			id_detalle
			id_orden,
			id_destino
		) VALUES (
			#idDetalle#
			#idorden#,
			#destino#
		)
	</insert>


	<select id="listarOrdenPlanificacion" parameterClass="ordenPlanificacionBean">
		select o.nu_orden as `Numero de Orden`, o.fe_order as `Fecha
		de Orden`,	c.nu_documento as `Numero Documento`, e.no_estado as
		`estado` from	orden o
		inner join cliente c on o.id_cliente =	c.id_cliente
		inner join	estado e on o.id_estado = e.id_estado
		where
		o.nu_orden = #nuOrden# or
		o.fe_order = #feOrder# or e.no_estado =
		#idEstado#

	</select>

	<select id="obtenerDataCotizacion" resultClass="hashmap">

		SELECT
		cz.fe_cotiza as `Fecha cotizacion`, c.nombres as `Nombres`,
		c.apellidos as `Apellidos`, cz.nu_adultos as `Numero de Adultos`,
		cz.nu_ninos as `Numero de Ni√±os`, cz.observacion as `Observacion`,
		cz.fe_partida as `Fecha de Partida`, cz.fe_retorno as `Fecha de
		Retorno`,
		cm.descripcion as `descripcion mot`, cz.im_presupuesto_maximo
		as `Presupuesto
		Maximo`, cz.im_presupuesto_minimo as `Presupuesto
		Minimo`,
		mv.descripcion as `Motivo de Viaje`, sv.nombre as `Servicios`,
		tp.nombre as `Tipo de Programa`, ta.descripcion as `Tipo Alojamiento`,
		tc.nombre as `Categoria Alojamiento`, dc.descripcion as `Ciudad
		Destino`
		FROM cliente as c INNER JOIN cotizacion cz ON cz.id_cliente =
		c.id_cliente
		INNER JOIN cotizacion_motivo cm ON cm.id_cotiza =
		cz.id_cotiza INNER
		JOIN motivo_viaje mv ON mv.id_motivo = cm.id_motivo
		INNER JOIN cotizacion_deta ct ON ct.id_cotiza = cz.id_cotiza INNER
		JOIN
		cotizacion_servicio cs on cs.id_cotiza = cz.id_cotiza
		INNER JOIN
		servicios sv on sv.id_servicio = cs.id_servicio INNER JOIN
		tipo_programa tp on cz.id_tipo_programa = tp.id_programa
		INNER JOIN
		tipo_alojamiento ta on cz.id_tipo_alojamiento =
		ta.id_tipo_alojamiento
		INNER JOIN tipo_categoria_alojamiento tc on
		cz.id_categoria_alojamiento =
		tc.id_tipo
		Inner JOIN destino_ciudad dc on
		cz.id_destino = dc.id_destino_ciudad
		where cz.nu_cotiza = #nuCotiza#;

	</select>
	<select id="obtenerArrayDestinos" resultClass="hashmap">
		SELECT * FROM
		proytraveldb.cotizacion_deta cd
		INNER JOIN cotizacion cz on
		cz.id_cotiza = cd.id_cotiza
		where cz.nu_cotiza = #nuCotiza#;
	</select>

	<insert id="insertarOrdenPlanificacion" parameterClass="ordenPlanificacionBean">
		INSERT
		INTO orden(
		nu_orden, observacion, descripcion, fe_order,
		autorizacion,
		im_presupuesto_minimo, im_presupuesto_maximo,
		id_cliente, fe_inicio, fe_fin, nu_adultos, nu_ninos)
		VALUES ( 
		#nuOrden#, #observacion#, #descripcion#, #feOrder#,
		#autorizacion#,
		#imPresupuestoMinimo#,
		#imPresupuestoMaximo#, #idCliente#,
		 #feInicio#, #feFin#, #nuAdultos#, #nuNinos# )
	</insert>
		<select id="obtenerNumeroOrden" resultClass="string">
		SELECT CONCAT('ORD',
               YEAR(NOW()), 
               IF( LENGTH(MONTH(NOW()))=1,CONCAT('0',MONTH(NOW())),MONTH(NOW()) ),
               MAX( SUBSTR( nu_orden, 11) ) +1 
               ) AS NRO_Orden
         FROM orden;
	</select>
	
	
		<insert id="insertarMotivoViaje" parameterClass="motivoViajeBean">
		INSERT INTO orden_motivo(
			id_orden,
			id_motivo
		) VALUES (
			#numeroOrden#,
			#codigoMotivo#
		)
	</insert>
	
	<insert id="insertarServicioAdicional" parameterClass="servicioAdicionalBean">
		INSERT INTO orden_servicio(
			id_orden,
			id_servicio
		) VALUES (
			#numeroOrden#,
			#codigoServicio#
		)
	</insert>
		
	<select id="listarCiudad" parameterClass="ciudadBean" resultMap="resultCiudad">
		SELECT id_destino_ciudad, id_destino_pais, descripcion FROM destino_ciudad 
         WHERE 1=1
		<isNotEmpty prepend="AND" property="idPais"> id_destino_pais = #idPais# </isNotEmpty>
	</select>
	<select id="listarPais" parameterClass="paisBean" resultMap="resultPais">
		SELECT id_destino, descripcion FROM destino_pais 
		WHERE 1=1
		<isNotEmpty prepend="AND" property="idPais"> id_destino != #idPais# </isNotEmpty>
	</select>	

</sqlMap>